---
description: 交互逻辑文档
globs: 
alwaysApply: false
---
# 交互逻辑文档 - Gemini 内容导出与美化插件

**1. 引言**

本文档旨在详细描述"Gemini 内容导出与美化插件"的用户交互流程和界面操作逻辑。它基于已定义的项目需求文档 (`cursor_rules.mdc`)，为插件的UI/UX设计和开发提供指导。

**2. 核心调用与模式选择**

*   **2.1. 访问导出选项 (在 Gemini 界面内)**
    *   **触发点**: 插件将增强 Gemini 原生回答框或深度研究报告下方的现有"复制"和/或"分享"按钮/图标的功能。
    *   **交互方式**:
        1.  用户用鼠标点击 Gemini 原有的"复制"或"分享"按钮（或其附近新增强的统一"导出"图标）上。
        2.  出现清晰的工具提示（Tooltip），如"导出内容"。
        3.  用户点击该按钮/图标。
        4.  弹出一个简洁的子菜单或下拉列表，提供以下选项：
            *   "复制为 Markdown"
            *   "下载为 Markdown (.md)" (基于需求文档 3.2.3 - 可选)
            *   "复制为图片"
            *   "下载为图片"
    *   **视觉反馈**: 交互元素应有清晰的 hover 和 active 状态。

**3. "导出为 Markdown" 流程**

*   **3.1. 初始化**: 用户从导出选项菜单中选择"复制为 Markdown"或"下载为 Markdown (.md)"。
*   **3.2. 内容处理**: 
    1.  插件自动捕获当前选定或关联的 Gemini 内容块 (HTML 格式)。
    2.  后台调用 `Turndown` 库将捕获到的 HTML 转换为 Markdown 格式的文本。
*   **3.3. 用户后续操作与反馈**:
    *   **若选择"复制为 Markdown"**: 
        1.  转换后的 Markdown 文本自动复制到用户剪贴板。
        2.  界面给出即时、短暂的成功提示，如："Markdown 已复制到剪贴板！" (例如，一个小的 toast 通知)。
    *   **若选择"下载为 Markdown (.md)"** (可选功能):
        1.  触发浏览器标准的"文件另存为"对话框。
        2.  默认文件名可设为 `gemini_export_YYYYMMDD_HHMMSS.md` 或从内容中提取部分标题。
        3.  下载完成后，可有短暂提示，如："Markdown 文件已开始下载。"

**4. "导出为图片" 流程**

*   **4.1. 初始化**: 用户从导出选项菜单中选择"复制为图片"或"下载为图片"。
*   **4.2. 内容捕获与图片生成**: 
    1.  插件自动捕获当前选定或关联的 Gemini 内容块的 DOM 元素。
    2.  后台调用核心图片生成模块 (`imageGenerator.ts`)，使用 `html2canvas` 将该 DOM 元素渲染为图片数据 (Blob)。
    3.  在图片生成过程中，应显示加载指示器。
*   **4.3. 用户后续操作与反馈**:
    *   **若选择"复制为图片"**: 
        1.  尝试使用 `navigator.clipboard.write()` API 将生成的图片 Blob 写入剪贴板。
        2.  界面给出即时、短暂的成功或失败提示，如："图片已复制到剪贴板！" 或 "复制图片失败！"。
    *   **若选择"下载为图片"**: 
        1.  使用生成的图片 Blob 创建一个临时的 URL (`URL.createObjectURL`)。
        2.  创建一个隐藏的 `<a>` 标签，设置 `href` 和 `download` 属性。
        3.  模拟点击 `<a>` 标签触发浏览器标准的"文件另存为"对话框。
        4.  默认文件名可设为 `gemini_export_YYYYMMDD_HHMMSS.png`。
        5.  下载开始后，给出短暂提示，如："图片文件已开始下载。"
        6.  适当时候释放临时 URL (`URL.revokeObjectURL`)。

**5. 插件图标交互 (浏览器工具栏)**

*   **5.1. 点击图标** (根据需求文档 3.4.2，此为可选功能):
    *   **行为**: 用户点击浏览器工具栏上的插件图标。
    *   **结果**: 弹出一个小型的 HTML 页面 (popup.html)。
    *   **Popup 内容**: 
        *   提供插件的简要说明。
        *   (可选) 快捷设置：如默认导出格式、默认图片质量等。
        *   链接到帮助/关于信息。
        *   (可选) 快速启用/禁用某些特性。

**6. 用户反馈与通知**

*   **6.1. 成功操作**: 
    *   对于快速操作（如复制 Markdown），使用简短、自消失的 Toast 通知 (例如："已复制到剪贴板")。
    *   对于下载操作，通知用户下载已开始。
*   **6.2. 进行中/加载状态**: 
    *   对于耗时可能较长操作（如图片生成），应在相关按钮或区域显示加载指示器 (spinner) 或进度提示，避免用户感觉程序无响应。
*   **6.3. 错误处理**: 
    *   **内容捕获失败**: 如果插件未能正确识别或捕获 Gemini 内容，应给出友好提示，如"未能捕获内容，请确保已选中 Gemini 的回答或报告后再试。"
    *   **Markdown 转换失败**: 提示用户"Markdown 转换失败，请稍后再试。"
    *   **图片生成失败**: 如果 `html2canvas` 生成图片过程中出错，提示用户"图片生成失败，请稍后再试或联系支持。"
    *   **剪贴板写入失败**: 对于复制图片操作，如果写入剪贴板失败（例如，浏览器不支持、权限问题或未知错误），提示用户"复制图片失败，请尝试下载。"
    *   **权限问题**: 如果缺少必要权限（如 `clipboardWrite`），应引导用户如何授予或提示功能不可用。
    *   所有错误提示都应清晰易懂，并尽可能提供解决方案或重试选项。

**7. 交互一致性与特殊场景**

*   **7.1. 无可选内容时**: 如果当前 Gemini 页面没有可供导出的回答或报告，或者用户未聚焦于任何特定内容块，插件的导出按钮应处于禁用 (disabled) 状态，或点击后提示"请先选择或聚焦于一个 Gemini 回答/报告"。
*   **7.2. Gemini 页面结构变更的应对**: 
    *   插件应设计得具有一定的鲁棒性，以应对 Gemini 前端 DOM 结构的微小变化。
    *   如果发生重大变更导致插件核心功能失效，当用户尝试使用时，应给出明确提示，例如："Gemini 页面结构已更新，插件暂时无法工作，请等待开发者更新。"
*   **7.3. 快捷键**: (未来扩展) 可考虑为常用操作（如复制 Markdown、复制图片）提供自定义快捷键支持。

本文档描述了核心的交互流程。在具体实现过程中，UI 设计师和开发者应紧密合作，确保用户体验的流畅与直观。
